<% provide(:title, 'Create event') %>

<div class="container">

  <div class="center">
    <h1>Create event</h1>
  </div>

  <div class="row">
    <div class="col-md-6 col-md-offset-3">
      <%= form_for(@event, url: newevent_path, html: { id: 'newEventForm' }) do |f| %>

        <%= render 'shared/error_messages', errors: @event.errors %>

        <%= f.label :name %>
        <%= f.text_field :name, class: 'form-control' %>

        <%= f.label :description %>
        <%= f.text_area :description, class: 'form-control' %>

        <%= f.label :start_date %>
        <%= f.date_field :start_date, class: 'form-control' %>

        <%= f.label :end_date %>
        <%= f.date_field :end_date, class: 'form-control' %>

        <div id="mapid"></div>

        <%= f.text_field :lat, { id: 'latField', type: 'hidden', value: 'x'} %>
        <%= f.text_field :lng, { id: 'lngField', type: 'hidden', value: 'x'} %>

        <%= f.label :capacity %>
        <%= f.text_field :capacity, class: 'form-control' %>

        <%= f.label :is_filter %>
        <%= f.check_box :is_filter, class: 'form-control', id: 'toggler' %>

        <div id="toggle" style="display: none;">
          <%= f.label :from_birth_date %>
          <%= f.date_field :from_birth_date, class: 'form-control' %>

          <%= label_tag "Permit genders:" %>
          <%= label_tag "Male" %>
          <%= check_box_tag "permit_gender[]", 0, { checked: true } %>
          <%= label_tag "Female" %>
          <%= check_box_tag "permit_gender[]", 1, { checked: true } %>

        </div>

        <p><%=  %></p>

        <%= f.submit "Create event", class: "btn btn-primary" %>
      <% end %>
    </div>
  </div>

</div>

<!--<script>-->
<!--  $("input#toggler").change(function(obj){-->
<!--      if($("input#toggler").is(":checked"))-->
<!--      {-->
<!--          $("div#toggle").css('display', 'block');-->
<!--      }-->
<!--      else-->
<!--      {-->
<!--          $("div#toggle").css('display', 'none');-->
<!--      }-->
<!--  });-->
<!--</script>-->

<script>

  var popup = L.popup();
  var eventPosMarker = null;
  var mymap = null;

  function addEventPosMarker(lat, lng)
  {
      if (eventPosMarker === null)
      {
          eventPosMarker = L.marker([lat, lng]).addTo(mymap);
      }
      else
      {
          eventPosMarker.setLatLng([lat, lng]).update();
      }

      eventPosMarker.bindPopup("Do you want to have your event here?").openPopup();
  }

  function onMapClick(e)
  {
      addEventPosMarker(e.latlng.lat, e.latlng.lng);
  }

  $(document).ready(function(){
      var lat = "<%= if params[:event] != nil and params[:event][:lat] != nil then params[:event][:lat] else 'x' end %>";
      var lng = "<%= if params[:event] != nil and params[:event][:lng] != nil then params[:event][:lng] else 'x' end %>";

      console.log(lat);
      console.log(lng);

      if(!(lat === 'x' || lng === 'x'))
      {
          mymap = addMap('mapid', [lat, lng]);
          addEventPosMarker(lat, lng);
          mymap.on('click', onMapClick);
      }
      else
      {
          var onLocationGet = function (lat, lng) {
              mymap = addMap('mapid', [lat, lng]);
              mymap.on('click', onMapClick);
          };

          var onLocationGetFailed = function () {
              mymap = addMap('mapid', [0, 0], 1);
              mymap.on('click', onMapClick);
          };

          getLocation(onLocationGet, onLocationGetFailed);
      }
  });

  $('#newEventForm').submit(function(){

      $('#latField').val(eventPosMarker === null ? "x" : eventPosMarker.getLatLng().lat);
      $('#lngField').val(eventPosMarker === null ? "x" : eventPosMarker.getLatLng().lng);
  });

</script>